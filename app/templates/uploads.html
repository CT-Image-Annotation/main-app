{% extends 'base.html' %} {% block content %}
<span class="title"><h1>{% block title %} Uploads{% endblock %}</h1></span>

<!-- File Upload Form -->
<div class="upload-container">
  <form
    action="{{ url_for('uploads.upload') }}"
    method="POST"
    enctype="multipart/form-data"
  >
    <label for="file">Choose a file:</label>
    <input type="file" id="file" name="file" required />
    <button type="submit">Upload</button>
  </form>
</div>

<!-- List of Uploaded Files -->
<h2>Uploaded Files:</h2>
<ul class="file-list">
  {% for file in files %}
  <li data-file-id="{{ file.id }}">
    <a href="{{ url_for('uploads.download', name=file.path) }}" target="_blank"
      >{{ file.path }}</a
    >
    <input
      type="color"
      id="colorPicker{{ file.id }}"
      value="#ff0000"
      style="margin-left: 10px"
    />
    <canvas id="drawingCanvas{{ file.id }}" width="600" height="400"></canvas>
    <img
      id="originalImage{{ file.id }}"
      src="data:image/png;base64,{{ imgs[file.id] }}"
      style="display: none"
    />
    <!-- <img src="data:image/png;base64,{{ imgs[file.id] }}" /> -->
    <!-- <button onclick="getCanvasImage{{ file.id }}()">Get Drawn Image</button> -->
  </li>
  {% endfor %}
</ul>

<script>
  // Define the function to handle canvas drawing
  function getCanvasImage(fileId) {
    const canvas = document.getElementById("drawingCanvas" + fileId);
    if (!canvas) {
      console.error("Canvas not found for file " + fileId);
      return;
    }

    const dataURL = canvas.toDataURL("image/png");
    console.log("Image for file " + fileId + ":", dataURL);
    // You can do something with the image dataURL here (e.g., download or upload)
  }

  // Loop through fileIds and setup the canvases
  const fileIds = JSON.parse(
    '{{ (files | map(attribute="id") | list) | tojson | safe }}'
  );

  fileIds.forEach(function (fileId) {
    const canvas = document.getElementById("drawingCanvas" + fileId);
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("colorPicker" + fileId);
    const imgElement = document.getElementById("originalImage" + fileId);
    const img = new Image();
    img.src = imgElement.src;

    img.onload = function () {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };

    // Drawing variables
    let drawing = false;
    let lastX = 0;
    let lastY = 0;

    let currentColor = colorPicker.value;
    colorPicker.addEventListener("input", function () {
      currentColor = colorPicker.value;
    });

    // Start drawing (mousedown)
    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      lastX = e.offsetX;
      lastY = e.offsetY;
    });

    // Draw on canvas while moving the mouse (mousemove)
    canvas.addEventListener("mousemove", (e) => {
      if (drawing) {
        ctx.beginPath();
        ctx.strokeStyle = currentColor;
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke(); // Draw the line
        lastX = e.offsetX;
        lastY = e.offsetY;
      }
    });

    // Stop drawing (mouseup)
    canvas.addEventListener("mouseup", () => {
      drawing = false;
    });

    // Optionally, add a listener for mouseout to stop drawing if the mouse leaves the canvas
    canvas.addEventListener("mouseout", () => {
      drawing = false;
    });
  });
</script>
{% endblock %}
