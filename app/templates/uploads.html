{% extends 'base.html' %}

{% block title %}Uploads{% endblock %}

{% block content %}
<div class="container" style="max-width:800px; margin:60px auto; padding:20px;">
  <!-- Create Dataset -->
  <div class="card" style="padding:20px; margin-bottom:30px;">
    <h2>Create New Dataset</h2>
    <form action="{{ url_for('uploads.datasets_index') }}" method="POST" style="display:flex; flex-direction:column; gap:10px;">
      <div>
        <label for="name">Name</label>
        <input id="name" name="name" type="text" required style="width:100%; padding:8px;">
      </div>
      <div>
        <label for="description">Description (optional)</label>
        <textarea id="description" name="description" style="width:100%; padding:8px;"></textarea>
      </div>
      <div>
        <label for="tags">Status</label>
        <select id="tags" name="tags" style="width:100%; padding:8px;">
          <option value="To Do">To Do</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <button type="submit" class="button">Create Dataset</button>
    </form>
  </div>

  <!-- Datasets List -->
  {% for ds in datasets %}
    <div class="card" style="padding:20px; margin-bottom:40px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:20px;">
          {% if ds.files|length > 0 %}
            {% set f = ds.files[0] %}
            <a href="{{ url_for('uploads.process', file_id=f.id) }}">
              <img src="{{ url_for('uploads.serve_dataset_file', ds_id=ds.id, filename=f.path) }}"
                   alt="{{ f.name }}"
                   style="width:100px; height:100px; object-fit:cover; border-radius:8px;">
            </a>
          {% else %}
            <div style="width:100px; height:100px; background:#eee; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#999;">
              No Image
            </div>
          {% endif %}
          <div>
            <h3>{{ ds.name }}</h3>
            {% if ds.description %}<p>{{ ds.description }}</p>{% endif %}
            <p>Status: <strong>{{ ds.tags }}</strong></p>
          </div>
        </div>
        <form action="{{ url_for('uploads.delete_dataset', ds_id=ds.id) }}" method="POST" onsubmit="return confirm('Are you sure?');">
          <button type="submit" class="button">Delete Dataset</button>
        </form>
      </div>

      <!-- Upload to Dataset -->
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=ds.id) }}" method="POST" enctype="multipart/form-data" style="margin-top:20px; display:flex; gap:10px; align-items:center;">
        <input type="file" name="files" multiple webkitdirectory style="flex:1;">
        <button type="submit" class="button">Upload Folder</button>
      </form>

      <!-- Dataset Files -->
      <ul style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; list-style:none; padding:0;">
        {% for file in ds.files %}
          <li style="position:relative;">
            <a href="{{ url_for('uploads.process', file_id=file.id) }}">
              <img src="{{ url_for('uploads.serve_dataset_file', ds_id=ds.id, filename=file.path) }}"
                   alt="{{ file.name }}"
                   style="width:80px; height:80px; object-fit:cover; border-radius:4px;">
            </a>
            <form action="{{ url_for('uploads.delete_file', file_id=file.id) }}" method="POST" style="position:absolute; top:0; right:0;">
              <button type="submit" style="background:rgba(255,0,0,0.7); color:white; border:none; border-radius:50%; width:20px; height:20px; padding:0; cursor:pointer;">Ã—</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <p>No datasets yet.</p>
  {% endfor %}
</div>
{% endblock %}
