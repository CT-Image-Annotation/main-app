{% extends 'base.html' %}

{% block title %}My Datasets{% endblock %}

{% block content %}
  <!-- Create Dataset -->
  <div class="card bg-dark text-light shadow p-4 mb-4">
    <h2 class="mb-3">Create New Dataset</h2>
    <form id="create-dataset-form" class="d-flex flex-column gap-3">
      <div>
        <label for="name" class="form-label">Name</label>
        <input id="name" name="name" type="text" required class="form-control bg-secondary text-light" />
      </div>
      <div>
        <label for="description" class="form-label">Description (optional)</label>
        <textarea id="description" name="description" class="form-control bg-secondary text-light"></textarea>
      </div>
      <button type="submit" class="btn btn-primary align-self-end mt-2">Create Dataset</button>
    </form>
  </div>

  <!-- Datasets List -->
  <div id="dataset-list" class="d-flex flex-column gap-4"></div>
  <p id="no-datasets" class="text-secondary d-none">No datasets yet.</p>

<script>

document.getElementById("create-dataset-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  const data = {
    name: formData.get("name"),
    description: formData.get("description"),
    owner_id: window.user.id,
    owner_type: "user"
  };

  try {
    const res = await fetch(urlCreateDataset, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      const result = await res.json();
      listDatasets();
    }
  } catch{}
});

async function listDatasets() {
  const userId = window.user?.id;
  if (!userId) return;

  const container = document.getElementById("dataset-list");
  const noDatasetsMsg = document.getElementById("no-datasets");
  container.innerHTML = "";

  try {
    const res = await fetch( urlReadUserDatasets(userId) );
    if (!res.ok) throw new Error("Failed to fetch datasets");
    const datasets = await res.json();

    if (datasets.length === 0) {
      noDatasetsMsg.classList.remove("d-none");
      return;
    }

    noDatasetsMsg.classList.add("d-none");

    datasets.forEach(ds => {
      const div = document.createElement("div");
      div.className = "card bg-dark text-light shadow p-4 mb-4 dataset-card";
      div.dataset.datasetId = ds.id;

      const file = ds.resources?.[0];
      
      div.innerHTML = `
        <!-- VIEW MODE -->
        <div class="dataset-info d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            ${
              file
                ? `<a href="${urlEditor(ds.id)}">
                    <img src="${urlFetchImage(file.path)}"
                          alt="${file.name}" class="rounded"
                          style="width:100px; height:100px; object-fit:cover;">
                  </a>`
                : `<div class="d-flex align-items-center justify-content-center bg-secondary text-muted rounded"
                      style="width:100px; height:100px;">No Image</div>`
            }
            <div>
              <h3><a href="${urlEditor(ds.id)}" class="text-info">${ds.name}</a></h3>
              ${ds.description ? `<p class="text-secondary small">${ds.description}</p>` : ""}
              <p>Status: <span class="fw-bold text-info">${ds.status}</span></p>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-info edit-btn">Edit</button>
            <button type="button" class="btn btn-outline-danger delete-btn">Delete</button>
          </div>
        </div>

        <!-- EDIT MODE -->
        <form class="edit-form d-none flex-column gap-3 mt-3">
          <div>
            <label class="form-label">Name</label>
            <input name="name" type="text" value="${ds.name}" required class="form-control bg-secondary text-light" />
          </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control bg-secondary text-light">${ds.description || ''}</textarea>
          </div>
          <div>
            <label class="form-label">Status</label>
            <select name="status" class="form-select bg-secondary text-light">
              <option value="todo" ${ds.status === 'todo' ? 'selected' : ''}>To Do</option>
              <option value="done" ${ds.status === 'done' ? 'selected' : ''}>Done</option>
            </select>
          </div>
          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary save-btn">Save</button>
            <button type="button" class="btn btn-outline-light cancel-btn">Cancel</button>
          </div>
        </form>

        <!-- Upload Folder -->
        <form class="upload-form d-flex gap-2 align-items-center mt-3" enctype="multipart/form-data">
          <input type="file" name="files" multiple class="form-control bg-secondary text-light" style="flex:1;">
          <button type="submit" class="btn btn-outline-info">Upload</button>
        </form>
      `;

      container.appendChild(div);
    });

    // For each card, toggle between view‐mode and inline edit‐mode
    document.querySelectorAll('.dataset-card').forEach(card => {
      const info    = card.querySelector('.dataset-info');
      const editForm = card.querySelector('.edit-form');
      const uploadForm = card.querySelector('.upload-form');
      const editBtn = card.querySelector('.edit-btn');
      const cancelBtn = card.querySelector('.cancel-btn');
      const deleteBtn = card.querySelector('.delete-btn');

      // Toggle edit mode
      editBtn.addEventListener('click', () => {
        info.classList.add('d-none');
        editForm.classList.remove('d-none');
        editForm.classList.add('d-flex');
      });

      cancelBtn.addEventListener('click', () => {
        info.classList.remove('d-none');
        editForm.classList.remove('d-flex');
        editForm.classList.add('d-none');
      });

      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(editForm);
        const datasetId = e.target.closest('.dataset-card')?.dataset.datasetId;
        formData.append('dataset_id', datasetId);

        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch(urlEditDataset, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            await listDatasets();
          } else {
            console.error('failed edit dataset');
          }
        } catch (err) {
          console.error(err);
        }
      });

      deleteBtn.addEventListener('click', async (e) => {
        const datasetId = e.target.closest('.dataset-card')?.dataset.datasetId;
        if (!confirm('Delete this dataset?')) return;
        try {
          const res = await fetch(urlDeleteDataset(datasetId), { method: 'DELETE' });
          if (res.ok) {
            await listDatasets();
          } else {
            console.error('failed to delete');
          }
        } catch (err) {
          console.error(err);
        }
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const datasetId = e.target.closest('.dataset-card')?.dataset.datasetId;
        const fileInput = uploadForm.querySelector('input[type="file"]');
        const files = fileInput.files;

        for (const file of files) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("owner_id", userId);
          formData.append("owner_type", "user");
          formData.append("type", "AImage");
          formData.append("dataset_id", datasetId);
        
          await fetch(urlUploadImage, {
            method: "POST",
            body: formData
          });
        }

        await listDatasets();
      });
  });

  } catch (err) {
    console.error("Error loading datasets:", err);
  }
}

document.addEventListener("DOMContentLoaded", listDatasets);
</script>
{% endblock %}
