{% extends 'base.html' %}

{% block title %}My Datasets{% endblock %}

{% block content %}
<div class="container" style="max-width:800px; margin:60px auto; padding:20px;">

  <!-- Create Dataset -->
  <div class="card" style="padding:20px; margin-bottom:30px;">
    <h2>Create New Dataset</h2>
    <form action="{{ url_for('uploads.datasets_index') }}" method="POST"
          style="display:flex; flex-direction:column; gap:10px;">
      <div>
        <label for="name">Name</label><br>
        <input id="name" name="name" type="text" required
               style="width:100%; padding:8px;">
      </div>
      <div>
        <label for="description">Description (optional)</label><br>
        <textarea id="description" name="description"
                  style="width:100%; padding:8px;"></textarea>
      </div>
      <div>
        <label for="tags">Status</label><br>
        <select id="tags" name="tags" style="width:100%; padding:8px;">
          <option value="To Do">To Do</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <button type="submit" class="button"
              style="width:150px; align-self:flex-end; margin-top:10px;">
        Create Dataset
      </button>
    </form>
  </div>

  <!-- Datasets List -->
  {% for ds in datasets %}
    <div class="card dataset-card" style="padding:20px; margin-bottom:40px; position:relative;">

      <!-- VIEW MODE -->
      <div class="dataset-info" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:20px;">
          {% if ds.files|length > 0 %}
            {% set f = ds.files[0] %}
            <a href="{{ url_for('uploads.dataset_detail', ds_id=ds.id) }}">
              <img src="{{ url_for('uploads.serve_dataset_file', ds_id=ds.id, filename=f.path) }}"
                   alt="{{ f.name }}"
                   style="width:100px; height:100px; object-fit:cover; border-radius:8px;">
            </a>
          {% else %}
            <div style="width:100px; height:100px; background:#eee; border-radius:8px;
                        display:flex; align-items:center; justify-content:center; color:#999;">
              No Image
            </div>
          {% endif %}
          <div>
            <h3><a href="{{ url_for('uploads.dataset_detail', ds_id=ds.id) }}">{{ ds.name }}</a></h3>
            {% if ds.description %}<p>{{ ds.description }}</p>{% endif %}
            <p>Status: <strong>{{ ds.tags }}</strong></p>
          </div>
        </div>

        <div style="display:flex; gap:10px;">
          <button type="button" class="button edit-btn">Edit</button>
          <form action="{{ url_for('uploads.delete_dataset', ds_id=ds.id) }}"
                method="POST"
                onsubmit="return confirm('Delete this dataset?');">
            <button type="submit" class="button">Delete</button>
          </form>
        </div>
      </div>

      <!-- EDIT MODE (hidden by default) -->
      <form class="edit-form"
            action="{{ url_for('uploads.edit_dataset', ds_id=ds.id) }}"
            method="POST"
            style="display:none; flex-direction:column; gap:10px; margin-top:20px;">

        <div>
          <label for="name-{{ ds.id }}">Name</label><br>
          <input id="name-{{ ds.id }}"
                 name="name"
                 type="text"
                 value="{{ ds.name }}"
                 required
                 style="width:100%; padding:8px;">
        </div>

        <div>
          <label for="desc-{{ ds.id }}">Description</label><br>
          <textarea id="desc-{{ ds.id }}"
                    name="description"
                    style="width:100%; padding:8px;">{{ ds.description or '' }}</textarea>
        </div>

        <div>
          <label for="tags-{{ ds.id }}">Status</label><br>
          <select id="tags-{{ ds.id }}"
                  name="tags"
                  style="width:100%; padding:8px;">
            <option value="To Do"  {% if ds.tags=='To Do'  %}selected{% endif %}>To Do</option>
            <option value="Done"   {% if ds.tags=='Done'   %}selected{% endif %}>Done</option>
          </select>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button type="submit" class="button">Save</button>
          <button type="button" class="button cancel-btn">Cancel</button>
        </div>
      </form>

      <!-- Upload to Dataset -->
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=ds.id) }}"
            method="POST" enctype="multipart/form-data"
            style="margin-top:20px; display:flex; gap:10px; align-items:center;">
        <input type="file" name="files" multiple webkitdirectory style="flex:1;">
        <button type="submit" class="button">Upload Folder</button>
      </form>
    </div>
  {% else %}
    <p>No datasets yet.</p>
  {% endfor %}

</div>

<script>
// For each card, toggle between view‐mode and inline edit‐mode
document.querySelectorAll('.dataset-card').forEach(card => {
  const info    = card.querySelector('.dataset-info');
  const editFrm = card.querySelector('.edit-form');
  const editBtn = card.querySelector('.edit-btn');
  const cancel  = card.querySelector('.cancel-btn');

  editBtn.addEventListener('click', () => {
    info.style.display    = 'none';
    editFrm.style.display = 'flex';
  });
  cancel.addEventListener('click', () => {
    editFrm.style.display = 'none';
    info.style.display    = 'flex';
  });
});
</script>
{% endblock %}
