{% extends 'base.html' %}

{% block title %}My Datasets{% endblock %}

{% block content %}
  <!-- Create Dataset -->
  <div class="card bg-dark text-light shadow p-4 mb-4">
    <h2 class="mb-3">Create New Dataset</h2>
    <form action="{{ url_for('uploads.datasets_index') }}" method="POST" class="d-flex flex-column gap-3">
      <div>
        <label for="name" class="form-label">Name</label>
        <input id="name" name="name" type="text" required class="form-control bg-secondary text-light" />
      </div>
      <div>
        <label for="description" class="form-label">Description (optional)</label>
        <textarea id="description" name="description" class="form-control bg-secondary text-light"></textarea>
      </div>
      <div>
        <label for="tags" class="form-label">Status</label>
        <select id="tags" name="tags" class="form-select bg-secondary text-light">
          <option value="To Do">To Do</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary align-self-end mt-2">Create Dataset</button>
    </form>
  </div>

  <!-- Datasets List -->
  {% for ds in datasets %}
    <div class="card bg-dark text-light shadow p-4 mb-4 dataset-card">
      <!-- VIEW MODE -->
      <div class="dataset-info d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          {% if ds.files|length > 0 %}
            {% set f = ds.files[0] %}
            <a href="{{ url_for('uploads.dataset_detail', ds_id=ds.id) }}">
              <img src="{{ url_for('uploads.serve_dataset_file', ds_id=ds.id, filename=f.path) }}"
                   alt="{{ f.name }}"
                   class="rounded" style="width:100px; height:100px; object-fit:cover;">
            </a>
          {% else %}
            <div class="d-flex align-items-center justify-content-center bg-secondary text-muted rounded" style="width:100px; height:100px;">No Image</div>
          {% endif %}
          <div>
            <h3><a href="{{ url_for('uploads.dataset_detail', ds_id=ds.id) }}" class="text-info">{{ ds.name }}</a></h3>
            {% if ds.description %}<p class="text-secondary small">{{ ds.description }}</p>{% endif %}
            <p>Status: <span class="fw-bold text-info">{{ ds.tags }}</span></p>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-info edit-btn">Edit</button>
          <form action="{{ url_for('uploads.delete_dataset', ds_id=ds.id) }}" method="POST" onsubmit="return confirm('Delete this dataset?');">
            <button type="submit" class="btn btn-outline-danger">Delete</button>
          </form>
        </div>
      </div>
      <!-- EDIT MODE (hidden by default) -->
      <form class="edit-form d-none flex-column gap-3 mt-3" action="{{ url_for('uploads.edit_dataset', ds_id=ds.id) }}" method="POST">
        <div>
          <label for="name-{{ ds.id }}" class="form-label">Name</label>
          <input id="name-{{ ds.id }}" name="name" type="text" value="{{ ds.name }}" required class="form-control bg-secondary text-light" />
        </div>
        <div>
          <label for="desc-{{ ds.id }}" class="form-label">Description</label>
          <textarea id="desc-{{ ds.id }}" name="description" class="form-control bg-secondary text-light">{{ ds.description or '' }}</textarea>
        </div>
        <div>
          <label for="tags-{{ ds.id }}" class="form-label">Status</label>
          <select id="tags-{{ ds.id }}" name="tags" class="form-select bg-secondary text-light">
            <option value="To Do"  {% if ds.tags=='To Do'  %}selected{% endif %}>To Do</option>
            <option value="Done"   {% if ds.tags=='Done'   %}selected{% endif %}>Done</option>
          </select>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-outline-light cancel-btn">Cancel</button>
        </div>
      </form>
      <!-- Upload to Dataset -->
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=ds.id) }}" method="POST" enctype="multipart/form-data" class="d-flex gap-2 align-items-center mt-3">
        <input type="file" name="files" multiple webkitdirectory class="form-control bg-secondary text-light" style="flex:1;">
        <button type="submit" class="btn btn-outline-info">Upload Folder</button>
      </form>
    </div>
  {% else %}
    <p class="text-secondary">No datasets yet.</p>
  {% endfor %}

<script>
// For each card, toggle between view‐mode and inline edit‐mode
document.querySelectorAll('.dataset-card').forEach(card => {
  const info    = card.querySelector('.dataset-info');
  const editFrm = card.querySelector('.edit-form');
  const editBtn = card.querySelector('.edit-btn');
  const cancel  = card.querySelector('.cancel-btn');

  editBtn.addEventListener('click', () => {
    info.style.display    = 'none';
    editFrm.style.display = 'flex';
  });
  cancel.addEventListener('click', () => {
    editFrm.style.display = 'none';
    info.style.display    = 'flex';
  });
});
</script>
{% endblock %}
