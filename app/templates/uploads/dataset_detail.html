{% extends 'base.html' %}

{% block title %}Dataset – {{ dataset.name }}{% endblock %}

{% block content %}
<div class="card bg-dark text-light shadow p-4 mb-4">
  <h1 class="mb-2">{{ dataset.name }}</h1>
  {% if dataset.description %}
    <p class="text-secondary">{{ dataset.description }}</p>
  {% endif %}
  <p>Status: <span class="fw-bold text-info">{{ dataset.tags }}</span></p>

  <!-- File Upload Form -->
  <div class="card bg-secondary bg-gradient text-light mb-4 p-3">
    <h3 class="mb-3">Upload Files</h3>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="mb-3">
          <h5>Upload Single File</h5>
          <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
            <label for="file-upload" class="form-label">Select a file to upload:</label>
            <input type="file" id="file-upload" name="files" accept=".jpg,.jpeg,.png,.gif,.dcm,.dicom" class="form-control mb-2">
            <div class="form-text text-light">Supported formats: JPG, PNG, GIF, DICOM</div>
            <button type="submit" class="btn btn-primary mt-2 w-100">Upload File</button>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="mb-3">
          <h5>Upload Folder</h5>
          <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
            <label for="folder-upload" class="form-label">Select a folder to upload:</label>
            <input type="file" id="folder-upload" name="files" webkitdirectory directory class="form-control mb-2">
            <div class="form-text text-light">Select a folder containing your files</div>
            <button type="submit" class="btn btn-primary mt-2 w-100">Upload Folder</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Editor Section -->
  <div class="editor-container d-flex flex-column align-items-center my-4">
    <div class="editor-toolbar mb-2"></div>
    <div class="editor-wrapper card bg-secondary bg-gradient p-3" style="position:relative;">
      <canvas id="image-canvas" style="position:absolute; top:0; left:0; z-index:1; width:100%; height:100%;"></canvas>
      <canvas id="annotation-canvas" style="position:absolute; top:0; left:0; z-index:2; width:100%; height:100%;"></canvas>
    </div>
  </div>

  <p class="text-center text-light">
    Image <span id="current-index">1</span> of {{ files|length }}
    {% if files and files[0].mime == 'application/dicom' %}
    | Slice <span id="current-slice">1</span> of <span id="total-slices">1</span>
    {% endif %}
  </p>

  <!-- Slim, professional toolbar -->
  <div class="d-flex flex-wrap justify-content-center align-items-center gap-3 py-2 mb-3" style="background: #23272b; border-radius: 0.5rem;">
    <div class="btn-group me-2" role="group" aria-label="Navigation">
      <button id="prev" class="btn btn-outline-light btn-sm" title="Previous Image">◀</button>
      <button id="next" class="btn btn-outline-light btn-sm" title="Next Image">▶</button>
      <button id="prev-slice" class="btn btn-outline-light btn-sm" title="Previous Slice">↑</button>
      <button id="next-slice" class="btn btn-outline-light btn-sm" title="Next Slice">↓</button>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="text-light mb-0" for="contour-method" style="font-size: 0.95em;">Contour:</label>
      <select id="contour-method" class="form-select form-select-sm w-auto">
        <option value="adaptive">Adaptive</option>
        <option value="canny">Canny</option>
        <option value="manual">Manual Threshold</option>
        <option value="otsu">Otsu</option>
      </select>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="text-light mb-0" for="contour-threshold" style="font-size: 0.95em;">Threshold:</label>
      <input type="range" id="contour-threshold" min="0" max="255" value="50" class="form-range w-auto" style="width:120px;">
      <span id="contour-threshold-value" class="text-light ms-1" style="font-size: 0.95em;">50</span>
    </div>
    <button id="toggle-contours" class="btn btn-outline-info btn-sm ms-2">Hide Contours</button>
  </div>

  <!-- Edit Controls -->
  <div id="edit-controls" class="mt-4">
    <form id="batch-filter-form" method="POST" action="{{ url_for('processing.batch_apply', ds_id=dataset.id) }}" class="d-flex flex-wrap gap-2 justify-content-center mb-3">
      {% for name in filter_names %}
        <button type="submit" name="filter_name" value="{{ name }}" class="btn btn-outline-info">{{ name }}</button>
      {% endfor %}
    </form>
    <div class="d-flex gap-2 justify-content-center align-items-center mb-2">
      <a href="{{ url_for('processing.batch_undo', ds_id=dataset.id) }}" class="btn btn-outline-warning">Undo All</a>
      <a href="{{ url_for('processing.batch_reset', ds_id=dataset.id) }}" class="btn btn-outline-danger">Reset All</a>
      <a href="{{ url_for('processing.batch_download', ds_id=dataset.id) }}" class="btn btn-outline-success">Download All</a>
      {% if files and files[0].mime == 'application/dicom' %}
      <button id="check-structure" class="btn btn-outline-info">Check Dataset Structure</button>
      {% endif %}
    </div>
    {% if processes %}
      <p class="mt-3"><strong>Applied Filters:</strong> <span class="text-info">{{ processes | join(' → ') }}</span></p>
    {% endif %}
    <div id="dataset-structure-info" class="mt-3 text-center" style="display: none;">
        <div class="spinner-border text-info" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
  </div>
</div>

<script type="module">
import { CursorManager } from "{{ url_for('static', filename='js/editor/CursorManager.js') }}";

document.addEventListener('DOMContentLoaded', function() {
    // Always output a valid JS array
    const fileIds = {{ files|default([])|map(attribute='id')|list|tojson }};
    let idx = 0;
    const currentIndexEl = document.getElementById('current-index');
    const currentSliceEl = document.getElementById('current-slice');
    const totalSlicesEl = document.getElementById('total-slices');
    const total = fileIds.length;
    const toolbarEl = document.querySelector('.editor-toolbar');
    const imageCanvas = document.getElementById('image-canvas');
    const annotationCanvas = document.getElementById('annotation-canvas');
    const filterForm = document.getElementById('batch-filter-form');
    let contoursVisible = true;

    function loadImageToCanvas(imageUrl, imageCanvas, annotationCanvas, callback) {
        console.log('Loading image from URL:', imageUrl);  // Debug log
        const img = new window.Image();
        img.onload = function() {
            console.log('Image loaded successfully');  // Debug log
            // Set wrapper size to match image
            const wrapper = imageCanvas.parentElement;
            wrapper.style.width = img.width + 'px';
            wrapper.style.height = img.height + 'px';

            // Set canvas pixel size to match image
            imageCanvas.width = img.width;
            imageCanvas.height = img.height;
            annotationCanvas.width = img.width;
            annotationCanvas.height = img.height;

            imageCanvas.style.width = annotationCanvas.style.width = img.width + 'px';
            imageCanvas.style.height = annotationCanvas.style.height = img.height + 'px';

            imageCanvas.getContext('2d').clearRect(0, 0, img.width, img.height);
            imageCanvas.getContext('2d').drawImage(img, 0, 0);
            annotationCanvas.getContext('2d').clearRect(0, 0, img.width, img.height);
            if (callback) callback();
        };
        img.onerror = function(error) {
            console.error('Failed to load image:', imageUrl, error);  // Debug log
            // Show error message on canvas
            const ctx = imageCanvas.getContext('2d');
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);
            ctx.fillStyle = '#dc3545';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Failed to load image', imageCanvas.width/2, imageCanvas.height/2);
        };
        img.src = imageUrl;
    }

    if (total > 0) {
        async function fetchDicomInfo(fileId) {
            try {
                const response = await fetch(`{{ url_for('processing.dicom_info', file_id=0) }}`.replace('0', fileId));
                if (!response.ok) throw new Error('Failed to fetch DICOM info');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error('Error fetching DICOM info:', error);
                return { total_slices: 1 };
            }
        }

        async function updateImage() {
            const imageUrl = `{{ url_for('processing.image', file_id=0) }}`.replace('0', fileIds[idx]);
            console.log('Updating image with URL:', imageUrl);  // Debug log
            currentIndexEl.textContent = idx + 1;
            toolbarEl.innerHTML = '';
            
            // Check if the first file is a DICOM file by checking its extension
            const firstFile = {{ files[0].path|tojson|safe }};
            const isDicom = firstFile.toLowerCase().endsWith('.dcm');
            console.log('First file:', firstFile);  // Debug log
            console.log('Is DICOM:', isDicom);  // Debug log
            
            if (isDicom) {
                // Fetch DICOM info for the current file
                const dicomInfo = await fetchDicomInfo(fileIds[idx]);
                if (totalSlicesEl) totalSlicesEl.textContent = dicomInfo.total_slices || total;
                if (currentSliceEl) currentSliceEl.textContent = idx + 1;
            }
            
            // Load image and reset annotation canvas
            loadImageToCanvas(imageUrl, imageCanvas, annotationCanvas, async function() {
                // Set up drawing tools on annotationCanvas only
                const imageManager = {
                    getContext: () => annotationCanvas.getContext('2d'),
                    getCanvas: () => annotationCanvas,
                    getRegions: () => [], // You can implement region tracking if needed
                    addRegion: () => {},
                };
                const cursorManager = CursorManager(imageManager);
                toolbarEl.innerHTML = ""; // Clear previous buttons
                toolbarEl.appendChild(cursorManager.getElement());
                cursorManager.bindCanvas(annotationCanvas);

                // --- Draw contours ---
                if (contoursVisible) {
                    try {
                        const method = document.getElementById('contour-method')?.value || 'adaptive';
                        const threshold = document.getElementById('contour-threshold')?.value || 50;
                        let url = `/process/contours/${fileIds[idx]}?method=${method}`;
                        if (method === 'manual') {
                            url += `&threshold=${threshold}`;
                        }
                        const response = await fetch(url);
                        const data = await response.json();
                        const ctx = annotationCanvas.getContext('2d');
                        ctx.save();
                        ctx.strokeStyle = 'lime';
                        ctx.lineWidth = 2;
                        data.contours.forEach(contour => {
                            if (contour.length < 2) return;
                            ctx.beginPath();
                            ctx.moveTo(contour[0][0], contour[0][1]);
                            for (let i = 1; i < contour.length; i++) {
                                ctx.lineTo(contour[i][0], contour[i][1]);
                            }
                            ctx.closePath();
                            ctx.stroke();
                        });
                        ctx.restore();
                    } catch (e) {
                        console.error('Failed to fetch or draw contours:', e);
                    }
                }
            });
        }

        // Handle slice navigation
        if (document.getElementById('prev-slice')) {
            document.getElementById('prev-slice').addEventListener('click', function() {
                if (idx > 0) {
                    idx--;
                    if (currentSliceEl) currentSliceEl.textContent = idx + 1;
                    console.log('Previous slice:', idx + 1);  // Debug log
                    updateImage();
                }
            });

            document.getElementById('next-slice').addEventListener('click', function() {
                if (idx < total - 1) {
                    idx++;
                    if (currentSliceEl) currentSliceEl.textContent = idx + 1;
                    console.log('Next slice:', idx + 1);  // Debug log
                    updateImage();
                }
            });
        }

        document.getElementById('prev').addEventListener('click', function() {
            idx = (idx - 1 + total) % total;
            if (currentSliceEl) currentSliceEl.textContent = idx + 1;
            updateImage();
        });

        document.getElementById('next').addEventListener('click', function() {
            idx = (idx + 1) % total;
            if (currentSliceEl) currentSliceEl.textContent = idx + 1;
            updateImage();
        });

        // Handle filter form submission
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            const filterName = e.submitter.value; // Get the value from the clicked button
            formData.append('filter_name', filterName);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the processes list if it exists
                    const processesEl = document.querySelector('#edit-controls p');
                    if (processesEl) {
                        processesEl.innerHTML = `<strong>Applied Filters:</strong> ${data.processes.join(' → ')}`;
                    }
                    
                    // Add a timestamp to force image reload
                    const timestamp = new Date().getTime();
                    const imageUrl = `{{ url_for('processing.image', file_id=0) }}`.replace('0', fileIds[idx]);
                    const finalUrl = `${imageUrl}?t=${timestamp}`;
                    
                    // Reload the current image to show the applied filter
                    loadImageToCanvas(finalUrl, imageCanvas, annotationCanvas, function() {
                        // Set up drawing tools on annotationCanvas only
                        const imageManager = {
                            getContext: () => annotationCanvas.getContext('2d'),
                            getCanvas: () => annotationCanvas,
                            getRegions: () => [], // You can implement region tracking if needed
                            addRegion: () => {},
                        };
                        const cursorManager = CursorManager(imageManager);
                        toolbarEl.innerHTML = ""; // Clear previous buttons
                        toolbarEl.appendChild(cursorManager.getElement());
                        cursorManager.bindCanvas(annotationCanvas);
                    });
                } else {
                    console.error('Failed to apply filter:', data.message);
                }
            })
            .catch(error => {
                console.error('Error applying filter:', error);
            });
        });

        // Add dataset structure check
        const checkStructureBtn = document.getElementById('check-structure');
        if (checkStructureBtn) {
            checkStructureBtn.addEventListener('click', async function() {
                const infoDiv = document.getElementById('dataset-structure-info');
                const spinner = infoDiv.querySelector('.spinner-border');
                
                try {
                    // Show loading spinner
                    infoDiv.style.display = 'block';
                    spinner.style.display = 'inline-block';
                    infoDiv.innerHTML = ''; // Clear previous content
                    infoDiv.appendChild(spinner);
                    
                    const response = await fetch(`{{ url_for('processing.dataset_info', ds_id=dataset.id) }}`);
                    const data = await response.json();
                    
                    // Hide spinner
                    spinner.style.display = 'none';
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to fetch dataset info');
                    }
                    
                    if (data.error) {
                        infoDiv.innerHTML = `
                            <div class="card bg-danger text-light p-3">
                                <h5>Error</h5>
                                <p>${data.error}</p>
                                ${data.file_path ? `<p class="small">File path: ${data.file_path}</p>` : ''}
                            </div>
                        `;
                        return;
                    }
                    
                    infoDiv.innerHTML = `
                        <div class="card bg-secondary text-light p-3">
                            <h5>Dataset Structure Information</h5>
                            <p>Type: <strong>${data.is_multi_slice ? 'Multi-slice' : 'Single-slice'}</strong> DICOM</p>
                            <p>Total Files: ${data.total_files}</p>
                            <p>DICOM Files: ${data.dicom_files}</p>
                            <p>Total Slices: ${data.total_slices}</p>
                            <hr class="border-light">
                            <h6>DICOM Metadata</h6>
                            <p>Modality: ${data.modality}</p>
                            <p>Image Size: ${data.rows} × ${data.columns} pixels</p>
                            <p>Bits Allocated: ${data.bits_allocated}</p>
                            <p>Samples per Pixel: ${data.samples_per_pixel}</p>
                            ${data.warning ? `<p class="text-warning">${data.warning}</p>` : ''}
                            <hr class="border-light">
                            <p class="small text-muted">File path: ${data.file_path}</p>
                        </div>
                    `;
                } catch (error) {
                    // Hide spinner
                    spinner.style.display = 'none';
                    
                    console.error('Error checking dataset structure:', error);
                    infoDiv.innerHTML = `
                        <div class="card bg-danger text-light p-3">
                            <h5>Error</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            });
        }

        // Add event listeners to update the threshold value and trigger updateImage on change
        document.getElementById('contour-threshold').addEventListener('input', function() {
            document.getElementById('contour-threshold-value').textContent = this.value;
        });
        document.getElementById('contour-method').addEventListener('change', updateImage);
        document.getElementById('contour-threshold').addEventListener('change', updateImage);

        // Add event listener for the button
        document.getElementById('toggle-contours').addEventListener('click', function() {
            contoursVisible = !contoursVisible;
            this.textContent = contoursVisible ? 'Hide Contours' : 'Show Contours';
            updateImage();
        });

        // Initialize the first image
        updateImage();
    }
});
</script>
{% endblock %}
