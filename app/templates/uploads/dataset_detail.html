{% extends 'base.html' %}

{% block title %}Dataset – {{ dataset.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dataset_detail.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
  <h1 class="mb-2">{{ dataset.name }}</h1>
  {% if dataset.description %}
    <p class="text-secondary">{{ dataset.description }}</p>
  {% endif %}

  <!-- Patient Information -->
  {% if dataset.patient_name %}
    <div class="card bg-dark text-light p-3 mb-3">
      <h5 class="mb-3">Patient Information</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Name:</strong> {{ dataset.patient_name }}</p>
          <p class="mb-1"><strong>ID:</strong> {{ dataset.patient_id }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>Date of Birth:</strong> {{ dataset.patient_dob.strftime('%Y-%m-%d') if dataset.patient_dob }}</p>
          <p class="mb-1"><strong>Gender:</strong> {{ dataset.patient_gender }}</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Scan Information -->
  {% if dataset.scan_type %}
    <div class="card bg-dark text-light p-3 mb-3">
      <h5 class="mb-3">Scan Information</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Type:</strong> {{ dataset.scan_type }}</p>
          <p class="mb-1"><strong>Date:</strong> {{ dataset.scan_date.strftime('%Y-%m-%d') if dataset.scan_date }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>Series Number:</strong> {{ dataset.scan_series_number }}</p>
          {% if dataset.scan_description %}
            <p class="mb-1"><strong>Description:</strong> {{ dataset.scan_description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  <p>Status: <span class="fw-bold text-info">{{ dataset.tags }}</span></p>

<!-- Segmentation Controls -->
<div id="controls" class="d-flex justify-content-center my-3">
  <button id="claheBtn" class="btn btn-outline-light me-2">Apply CLAHE</button>
  <button id="resetBtn" class="btn btn-outline-light">Reset</button>
</div>

<!-- Selection Type Radio Buttons -->
<div class="selection-type">
  <!-- Only including the requested selection types (excluding box select) -->
  <label>
    <input type="radio" name="selectionType" value="draw" checked> Draw Tool
  </label>
  <label>
    <input type="radio" name="selectionType" value="positive"> Positive Point
  </label>
  <label>
    <input type="radio" name="selectionType" value="negative"> Negative Point
  </label>
</div>

<!-- Segmentation Action Buttons -->
<div id="segmentationControls">
  <button id="runSegmentation" class="btn btn-primary" disabled>Run Segmentation</button>
  <button id="clearSelections" class="btn btn-secondary">Clear All</button>
</div>

<!-- Info Panel for Points and Box Info -->
<div id="infoPanel">
  <div id="boxInfo"></div>
  <div id="pointsList"></div>
</div>

<!-- Image Viewer Section -->
<div class="editor-container d-flex flex-column align-items-center my-4">
  <!-- Image Wrapper -->
  <div id="canvasContainer" class="editor-wrapper card bg-secondary bg-gradient position-relative mx-auto" style="display:inline-block; padding:0;">
    <!-- Navigation arrows with improved positioning -->
    <button id="prev" class="btn btn-outline-light nav-arrow nav-left position-absolute" style="left: 10px; top: 50%; transform: translateY(-50%); z-index: 100;">◀</button>
    
    <!-- Base image canvas -->
    <canvas id="canvas" style="position:relative;"></canvas>
    
    <button id="next" class="btn btn-outline-light nav-arrow nav-right position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); z-index: 100;">▶</button>
    
    <!-- Mask Navigation -->
    <div id="maskNavigation" style="display: none;">
      <div id="maskInfo">Mask 1/3</div>
      <button id="prevMask" class="btn btn-sm btn-dark">▲</button>
      <button id="nextMask" class="btn btn-sm btn-dark">▼</button>
    </div>
  </div>
</div>

<p class="text-center text-light">Image <span id="current-index">1</span> of {{ files|length }}</p>

<!-- Images Slider -->
<div class="d-flex justify-content-center my-3">
  <input type="range" id="image-slider" class="form-range" style="width:80%; max-width:500px;"
          min="1" max="{{ files|length }}" value="1">
</div>

<!-- Load the segmentation tools script -->
<script src="{{ url_for('static', filename='js/editor/segmentation_tools.js') }}"></script>

<!-- Initialize the tools after the script is loaded -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get file IDs and URL template
    const fileIds = {{ files|map(attribute='id')|list|tojson }};
    const urlTemplate = "{{ url_for('processing.image', file_id=0) }}";
    
    // Make sure the script is fully loaded before initializing
    if (typeof window.initializeImageNavigation === 'function') {
      window.initializeImageNavigation(fileIds, urlTemplate);
    } else {
      console.error("Segmentation tools not loaded correctly. Trying again in 500ms...");
      // Try again after a delay in case the script is still loading
      setTimeout(() => {
        if (typeof window.initializeImageNavigation === 'function') {
          window.initializeImageNavigation(fileIds, urlTemplate);
        } else {
          console.error("Failed to load segmentation tools.");
        }
      }, 500);
    }
  });
</script>

{% endblock %}