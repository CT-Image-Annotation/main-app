{% extends 'base.html' %}

{% block title %}Dataset – {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container" style="max-width:800px; margin:60px auto; text-align:center;">

  <h1>{{ dataset.name }}</h1>
  {% if dataset.description %}
    <p>{{ dataset.description }}</p>
  {% endif %}
  <p>Status: <strong>{{ dataset.tags }}</strong></p>

  <!-- File Upload Form -->
  <div style="margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px;">
    <h3>Upload Files</h3>
    
    <!-- Single File Upload -->
    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
      <h4>Upload Single File</h4>
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
        <div style="margin: 10px 0;">
          <label for="file-upload" style="display: block; margin-bottom: 10px;">Select a file to upload:</label>
          <input type="file" 
                 id="file-upload" 
                 name="files" 
                 accept=".jpg,.jpeg,.png,.gif,.dcm,.dicom"
                 style="display: block; margin: 0 auto;">
          <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Supported formats: JPG, PNG, GIF, DICOM
          </p>
        </div>
        <button type="submit" class="button" style="margin-top: 10px;">Upload File</button>
      </form>
    </div>

    <!-- Folder Upload -->
    <div>
      <h4>Upload Folder</h4>
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
        <div style="margin: 10px 0;">
          <label for="folder-upload" style="display: block; margin-bottom: 10px;">Select a folder to upload:</label>
          <input type="file" 
                 id="folder-upload" 
                 name="files" 
                 webkitdirectory 
                 directory
                 style="display: block; margin: 0 auto;">
          <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Select a folder containing your files
          </p>
        </div>
        <button type="submit" class="button" style="margin-top: 10px;">Upload Folder</button>
      </form>
    </div>
  </div>

  <!-- Editor Section -->
  <div class="editor-container" style="display: flex; flex-direction: column; align-items: center; margin: 40px 0;">
    <div class="editor-toolbar" style="margin-bottom: 8px;"></div>
    <div class="editor-wrapper" style="position:relative; background:#222; border-radius:8px; box-shadow:0 2px 8px #0002;">
      <canvas id="image-canvas" style="position:absolute; top:0; left:0; z-index:1; width:100%; height:100%;"></canvas>
      <canvas id="annotation-canvas" style="position:absolute; top:0; left:0; z-index:2; width:100%; height:100%;"></canvas>
    </div>
  </div>

  <p style="text-align:center;">Image <span id="current-index">1</span> of {{ files|length }}</p>

  <!-- Navigation Buttons -->
  <div style="margin:10px 0; text-align:center;">
    <button id="prev" class="button">◀</button>
    <button id="next" class="button">▶</button>
  </div>

  <!-- Edit Controls -->
  <div id="edit-controls" style="margin-top:30px;">
    <form id="batch-filter-form"
          method="POST"
          action="{{ url_for('processing.batch_apply', ds_id=dataset.id) }}"
          style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
      {% for name in filter_names %}
        <button type="submit" name="filter_name" value="{{ name }}" class="button" style="margin:5px;">
          {{ name }}
        </button>
      {% endfor %}
    </form>

    <div style="margin-top:20px; display:flex; gap:10px; justify-content:center; align-items:center;">
      <a href="{{ url_for('processing.batch_undo',   ds_id=dataset.id) }}" class="button">Undo All</a>
      <a href="{{ url_for('processing.batch_reset',  ds_id=dataset.id) }}" class="button">Reset All</a>
      <a href="{{ url_for('processing.batch_download', ds_id=dataset.id) }}" class="button">Download All</a>
    </div>

    {% if processes %}
      <p style="margin-top:15px;"><strong>Applied Filters:</strong> {{ processes | join(' → ') }}</p>
    {% endif %}
  </div>

</div>

<script type="module">
import { CursorManager } from "{{ url_for('static', filename='js/editor/CursorManager.js') }}";

function loadImageToCanvas(imageUrl, imageCanvas, annotationCanvas, callback) {
    const img = new window.Image();
    img.onload = function() {
        // Set wrapper size to match image
        const wrapper = imageCanvas.parentElement;
        wrapper.style.width = img.width + 'px';
        wrapper.style.height = img.height + 'px';

        // Set canvas pixel size to match image
        imageCanvas.width = img.width;
        imageCanvas.height = img.height;
        annotationCanvas.width = img.width;
        annotationCanvas.height = img.height;

        imageCanvas.style.width = annotationCanvas.style.width = img.width + 'px';
        imageCanvas.style.height = annotationCanvas.style.height = img.height + 'px';

        imageCanvas.getContext('2d').clearRect(0, 0, img.width, img.height);
        imageCanvas.getContext('2d').drawImage(img, 0, 0);
        annotationCanvas.getContext('2d').clearRect(0, 0, img.width, img.height);
        if (callback) callback();
    };
    img.onerror = function() {
        console.error('Failed to load image:', imageUrl);
        // Show error message on canvas
        const ctx = imageCanvas.getContext('2d');
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);
        ctx.fillStyle = '#dc3545';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Failed to load image', imageCanvas.width/2, imageCanvas.height/2);
    };
    img.src = imageUrl;
}

document.addEventListener('DOMContentLoaded', function() {
    // Always output a valid JS array
    const fileIds = {{ files|default([])|map(attribute='id')|list|tojson }};
    let idx = 0;
    const currentIndexEl = document.getElementById('current-index');
    const total = fileIds.length;
    const toolbarEl = document.querySelector('.editor-toolbar');
    const imageCanvas = document.getElementById('image-canvas');
    const annotationCanvas = document.getElementById('annotation-canvas');
    const filterForm = document.getElementById('batch-filter-form');

    if (total > 0) {
        function updateImage() {
            const imageUrl = `{{ url_for('processing.image', file_id=0) }}`.replace('0', fileIds[idx]);
            currentIndexEl.textContent = idx + 1;
            toolbarEl.innerHTML = '';
            // Load image and reset annotation canvas
            loadImageToCanvas(imageUrl, imageCanvas, annotationCanvas, function() {
                // Set up drawing tools on annotationCanvas only
                const imageManager = {
                    getContext: () => annotationCanvas.getContext('2d'),
                    getCanvas: () => annotationCanvas,
                    getRegions: () => [], // You can implement region tracking if needed
                    addRegion: () => {},
                };
                const cursorManager = CursorManager(imageManager);
                toolbarEl.appendChild(cursorManager.getElement());
                cursorManager.bindCanvas(annotationCanvas);
            });
        }

        document.getElementById('prev').addEventListener('click', function() {
            idx = (idx - 1 + total) % total;
            updateImage();
        });

        document.getElementById('next').addEventListener('click', function() {
            idx = (idx + 1) % total;
            updateImage();
        });

        // Handle filter form submission
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            const filterName = e.submitter.value; // Get the value from the clicked button
            formData.append('filter_name', filterName);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the processes list if it exists
                    const processesEl = document.querySelector('#edit-controls p');
                    if (processesEl) {
                        processesEl.innerHTML = `<strong>Applied Filters:</strong> ${data.processes.join(' → ')}`;
                    }
                    
                    // Add a timestamp to force image reload
                    const timestamp = new Date().getTime();
                    const imageUrl = `{{ url_for('processing.image', file_id=0) }}`.replace('0', fileIds[idx]) + `?t=${timestamp}`;
                    
                    // Reload the current image to show the applied filter
                    loadImageToCanvas(imageUrl, imageCanvas, annotationCanvas, function() {
                        // Set up drawing tools on annotationCanvas only
                        const imageManager = {
                            getContext: () => annotationCanvas.getContext('2d'),
                            getCanvas: () => annotationCanvas,
                            getRegions: () => [], // You can implement region tracking if needed
                            addRegion: () => {},
                        };
                        const cursorManager = CursorManager(imageManager);
                        toolbarEl.appendChild(cursorManager.getElement());
                        cursorManager.bindCanvas(annotationCanvas);
                    });
                } else {
                    console.error('Failed to apply filter:', data.message);
                }
            })
            .catch(error => {
                console.error('Error applying filter:', error);
            });
        });

        // Initialize the first image
        updateImage();
    }
});
</script>
{% endblock %}
