{% extends 'base.html' %}

{% block title %}Dataset – {{ dataset.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dataset_detail.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
  <h1 class="mb-2">{{ dataset.name }}</h1>
  {% if dataset.description %}
    <p class="text-secondary">{{ dataset.description }}</p>
  {% endif %}

  <!-- Patient Information -->
  {% if dataset.patient_name %}
    <div class="card bg-dark text-light p-3 mb-3">
      <h5 class="mb-3">Patient Information</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Name:</strong> {{ dataset.patient_name }}</p>
          <p class="mb-1"><strong>ID:</strong> {{ dataset.patient_id }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>Date of Birth:</strong> {{ dataset.patient_dob.strftime('%Y-%m-%d') if dataset.patient_dob }}</p>
          <p class="mb-1"><strong>Gender:</strong> {{ dataset.patient_gender }}</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Scan Information -->
  {% if dataset.scan_type %}
    <div class="card bg-dark text-light p-3 mb-3">
      <h5 class="mb-3">Scan Information</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Type:</strong> {{ dataset.scan_type }}</p>
          <p class="mb-1"><strong>Date:</strong> {{ dataset.scan_date.strftime('%Y-%m-%d') if dataset.scan_date }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>Series Number:</strong> {{ dataset.scan_series_number }}</p>
          {% if dataset.scan_description %}
            <p class="mb-1"><strong>Description:</strong> {{ dataset.scan_description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  <p>Status: <span class="fw-bold text-info">{{ dataset.tags }}</span></p>

  <!-- Image Controls -->
  <div id="image-controls" class="d-flex flex-row align-items-center gap-3 mt-3" style="background:#23272b; border-radius:8px; padding:12px;">
    <label class="text-light mb-0" for="brightness-slider">Brightness</label>
    <input type="range" id="brightness-slider" min="-100" max="100" value="0" style="width:120px;">
    <span id="brightness-value" class="text-light">0</span>
    <label class="text-light mb-0 ms-3" for="contrast-slider">Contrast</label>
    <input type="range" id="contrast-slider" min="-100" max="100" value="0" style="width:120px;">
    <span id="contrast-value" class="text-light">0</span>
  </div>
  <div id="drawing-tools" class="d-flex flex-row align-items-center gap-3 mt-3" style="background:#23272b; border-radius:8px; padding:12px;">
    <button class="btn btn-outline-light btn-sm" id="tool-pen" title="Freehand">✏️ Pen</button>
    <button class="btn btn-outline-light btn-sm" id="tool-rect" title="Rectangle">▭ Rect</button>
    <button class="btn btn-outline-light btn-sm" id="tool-circle" title="Circle">◯ Circle</button>
    <button class="btn btn-outline-light btn-sm" id="tool-eraser" title="Eraser">🧽 Eraser</button>
    <label class="text-light mb-0 ms-3" for="brush-size">Brush Size</label>
    <input type="range" id="brush-size" min="1" max="30" value="5" style="width:100px;">
    <span id="brush-size-value" class="text-light">5</span>
    <label class="text-light mb-0 ms-3" for="brush-color">Color</label>
    <input type="color" id="brush-color" value="#00ff00" style="width: 30px; height: 30px;">
    <button class="btn btn-outline-warning btn-sm ms-3" id="tool-undo" title="Undo">↩️ Undo</button>
    <button class="btn btn-outline-warning btn-sm" id="tool-redo" title="Redo">↪️ Redo</button>
    <button class="btn btn-outline-danger btn-sm" id="tool-clear" title="Clear">🗑️ Clear</button>
  </div>
</div>

<!-- Editor Section -->
<div class="editor-container d-flex flex-column align-items-center my-4">
  <div class="editor-toolbar mb-2"></div>
  <div class="editor-wrapper card bg-secondary bg-gradient p-3" style="position:relative;">
    <canvas id="image-canvas" style="position:absolute; top:0; left:0; z-index:1; width:100%; height:100%;"></canvas>
    <canvas id="annotation-canvas" style="position:absolute; top:0; left:0; z-index:2; width:100%; height:100%;"></canvas>
  </div>
</div>

<p class="text-center text-light">
  Image <span id="current-index">1</span> of {{ files|length }}
  {% if files and files[0].mime == 'application/dicom' %}
  | Slice <span id="current-slice">1</span> of <span id="total-slices">1</span>
  {% endif %}
</p>

<!-- Slim, professional toolbar -->
<div class="d-flex flex-wrap justify-content-center align-items-center gap-3 py-2 mb-3" style="background: #23272b; border-radius: 0.5rem;">
  <div class="btn-group me-2" role="group" aria-label="Navigation">
    <button id="prev" class="btn btn-outline-light btn-sm" title="Previous Image">◀</button>
    <button id="next" class="btn btn-outline-light btn-sm" title="Next Image">▶</button>
    <button id="prev-slice" class="btn btn-outline-light btn-sm" title="Previous Slice">↑</button>
    <button id="next-slice" class="btn btn-outline-light btn-sm" title="Next Slice">↓</button>
  </div>
  <div class="d-flex align-items-center gap-2">
    <label class="text-light mb-0" for="contour-method" style="font-size: 0.95em;">Contour:</label>
    <select id="contour-method" class="form-select form-select-sm w-auto">
      <option value="adaptive">Adaptive</option>
      <option value="canny">Canny</option>
      <option value="manual">Manual Threshold</option>
      <option value="otsu">Otsu</option>
    </select>
  </div>
  <div class="d-flex align-items-center gap-2">
    <label class="text-light mb-0" for="contour-threshold" style="font-size: 0.95em;">Threshold:</label>
    <input type="range" id="contour-threshold" min="0" max="255" value="50" class="form-range w-auto" style="width:120px;">
    <span id="contour-threshold-value" class="text-light ms-1" style="font-size: 0.95em;">50</span>
  </div>
  <div class="d-flex align-items-center gap-2">
    <label class="text-light mb-0" for="interpolation-slices" style="font-size: 0.95em;">Interp. Slices:</label>
    <input type="number" id="interpolation-slices" min="0" max="10" value="0" class="form-control form-control-sm" style="width:60px;">
  </div>
  <button id="toggle-contours" class="btn btn-outline-info btn-sm ms-2">Hide Contours</button>
  <button id="toggle-interpolation" class="btn btn-outline-warning btn-sm ms-2">Enable Interpolation</button>
  <button id="reconstruct-volume" class="btn btn-outline-success btn-sm ms-2">Reconstruct Volume</button>
</div>

<!-- Edit Controls -->
<div id="edit-controls" class="mt-4">
  <form id="batch-filter-form" method="POST" action="{{ url_for('processing.batch_apply', ds_id=dataset.id) }}" class="d-flex flex-wrap gap-2 justify-content-center mb-3">
    {% for name in filter_names %}
      <button type="submit" name="filter_name" value="{{ name }}" class="btn btn-outline-info">{{ name }}</button>
    {% endfor %}
  </form>
  <div class="d-flex gap-2 justify-content-center align-items-center mb-2">
    <a href="{{ url_for('processing.batch_undo', ds_id=dataset.id) }}" class="btn btn-outline-warning">Undo All</a>
    <a href="{{ url_for('processing.batch_reset', ds_id=dataset.id) }}" class="btn btn-outline-danger">Reset All</a>
    <a href="{{ url_for('processing.batch_download', ds_id=dataset.id) }}" class="btn btn-outline-success">Download All</a>
    {% if files and files[0].mime == 'application/dicom' %}
    <button id="check-structure" class="btn btn-outline-info">Check Dataset Structure</button>
    {% endif %}
  </div>
  {% if processes %}
    <p class="mt-3"><strong>Applied Filters:</strong> <span class="text-info">{{ processes | join(' → ') }}</span></p>
  {% endif %}
</div>

<script>
  // Pass data to JavaScript
  window.datasetId = {{ dataset.id|tojson }};
  window.fileIds = {{ files|default([])|map(attribute='id')|list|tojson }};
</script>
<script src="{{ url_for('static', filename='js/dataset_detail.js') }}"></script>
{% endblock %}
