{% extends 'base.html' %}

{% block title %}Dataset – {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container" style="max-width:800px; margin:60px auto; text-align:center;">

  <h1>{{ dataset.name }}</h1>
  {% if dataset.description %}
    <p>{{ dataset.description }}</p>
  {% endif %}
  <p>Status: <strong>{{ dataset.tags }}</strong></p>

  <!-- File Upload Form -->
  <div style="margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px;">
    <h3>Upload Files</h3>
    
    <!-- Single File Upload -->
    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
      <h4>Upload Single File</h4>
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
        <div style="margin: 10px 0;">
          <label for="file-upload" style="display: block; margin-bottom: 10px;">Select a file to upload:</label>
          <input type="file" 
                 id="file-upload" 
                 name="files" 
                 accept=".jpg,.jpeg,.png,.gif,.dcm,.dicom"
                 style="display: block; margin: 0 auto;">
          <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Supported formats: JPG, PNG, GIF, DICOM
          </p>
        </div>
        <button type="submit" class="button" style="margin-top: 10px;">Upload File</button>
      </form>
    </div>

    <!-- Folder Upload -->
    <div>
      <h4>Upload Folder</h4>
      <form action="{{ url_for('uploads.upload_to_dataset', ds_id=dataset.id) }}" method="post" enctype="multipart/form-data">
        <div style="margin: 10px 0;">
          <label for="folder-upload" style="display: block; margin-bottom: 10px;">Select a folder to upload:</label>
          <input type="file" 
                 id="folder-upload" 
                 name="files" 
                 webkitdirectory 
                 directory
                 style="display: block; margin: 0 auto;">
          <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Select a folder containing your files
          </p>
        </div>
        <button type="submit" class="button" style="margin-top: 10px;">Upload Folder</button>
      </form>
    </div>
  </div>

  <script type="module" src="{{ url_for('static', filename='js/editor/editor.js') }}"></script>
  
  <!-- Editor with Navigation -->
  <div style="position:relative; margin:20px auto; max-width:100%;">
    <button id="prev" class="button"
            style="position:absolute; left:0; top:50%; transform:translateY(-50%); z-index:1000;">◀</button>
    
    <div class="editor" id="editor-container"></div>
    
    <button id="next" class="button"
            style="position:absolute; right:0; top:50%; transform:translateY(-50%); z-index:1000;">▶</button>
  </div>

  <p>Image <span id="current-index">1</span> of {{ files|length }}</p>

  <!-- Edit Controls (always visible) -->
  <div id="edit-controls" style="margin-top:30px;">
    <form id="batch-filter-form"
          method="POST"
          action="{{ url_for('processing.batch_apply', ds_id=dataset.id) }}"
          style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
      {% for name in filter_names %}
        <button type="submit" name="filter_name" value="{{ name }}" class="button" style="margin:5px;">
          {{ name }}
        </button>
      {% endfor %}
    </form>

    <div style="margin-top:20px; display:flex; gap:10px; justify-content:center; align-items:center;">
      <a href="{{ url_for('processing.batch_undo',   ds_id=dataset.id) }}" class="button">Undo All</a>
      <a href="{{ url_for('processing.batch_reset',  ds_id=dataset.id) }}" class="button">Reset All</a>
      <a href="{{ url_for('processing.batch_download', ds_id=dataset.id) }}" class="button">Download All</a>
    </div>

    {% if processes %}
      <p style="margin-top:15px;"><strong>Applied Filters:</strong> {{ processes | join(' → ') }}</p>
    {% endif %}
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fileIds = {{ files|map(attribute='id')|list|tojson }};
  let idx = 0;
  const currentIndexEl = document.getElementById('current-index');
  const total = fileIds.length;
  const editorContainer = document.getElementById('editor-container');

  if (total > 0) {
    function updateImage() {
      const imageUrl = `{{ url_for('processing.image', file_id=0) }}`.replace('0', fileIds[idx]);
      // Update the editor with the new image
      const editor = document.querySelector('.editor');
      if (editor) {
        editor.innerHTML = `<img src="${imageUrl}" style="max-width:100%; height:auto;">`;
      }
      currentIndexEl.textContent = idx + 1;
    }

    document.getElementById('prev').addEventListener('click', function() {
      idx = (idx - 1 + total) % total;
      updateImage();
    });

    document.getElementById('next').addEventListener('click', function() {
      idx = (idx + 1) % total;
      updateImage();
    });

    // Initialize the first image
    updateImage();
  }
});
</script>
{% endblock %}
